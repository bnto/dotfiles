#!/usr/bin/env bash

STATUS_FILE="/tmp/pomo_status"
PID_FILE="/tmp/pomo_pid"
STATE_FILE="/tmp/pomo_state"
POMODORO_DURATION=1500  # 25 minutes
BREAK_DURATION=300      # 5 minutes

update_status() {
    echo "$1" > "$STATUS_FILE"
    tmux refresh-client -S
}

run_timer() {
    local duration=$1
    local emoji=$2

    SECONDS_LEFT=$duration
    while [ $SECONDS_LEFT -gt 0 ]; do
        MIN=$((SECONDS_LEFT / 60))
        SEC=$((SECONDS_LEFT % 60))
        update_status "  $emoji  $(printf "%02d:%02d" $MIN $SEC)"
        sleep 1
        SECONDS_LEFT=$((SECONDS_LEFT - 1))
    done
}

start_pomodoro() {
    (
        echo "running" > "$STATE_FILE"
        run_timer $POMODORO_DURATION $(printf '\xEE\x80\x81')
        update_status "  $(printf '\xEF\x83\xB4') "
        sleep 3
        echo "break" > "$STATE_FILE"
        run_timer $BREAK_DURATION $(printf '\xEF\x83\xB4')
        update_status "  $(printf '\xEE\x80\x81') "
        rm -f "$PID_FILE" "$STATE_FILE"
    ) &
    echo $! > "$PID_FILE"
}

toggle_pomodoro() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        STATE=$(cat "$STATE_FILE" 2>/dev/null)

        if kill -0 "$PID" 2>/dev/null; then
            if [ "$STATE" = "paused" ]; then
                kill -CONT "$PID"
                echo "running" > "$STATE_FILE"
                # echo "Pomodoro resumed"
                tmux display-message "Pomodoro resumed"
            else
                kill -STOP "$PID"
                echo "paused" > "$STATE_FILE"
                # echo "Pomodoro paused"
                tmux display-message "Pomodoro paused"
            fi
        else
            echo "No active Pomodoro process"
            rm -f "$PID_FILE"
        fi
    else
        start_pomodoro
    fi
}

cancel_pomodoro() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            kill -9 "$PID"
        fi
        rm -f "$PID_FILE" "$STATE_FILE"
        update_status ""
        echo "Pomodoro canceled"
    else
        echo "No Pomodoro running"
    fi
}

case "$1" in
    cancel) cancel_pomodoro ;;
    *) toggle_pomodoro ;;
esac
