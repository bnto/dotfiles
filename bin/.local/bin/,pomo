#!/usr/bin/env bash

STATUS_FILE="/tmp/pomo_status"
PID_FILE="/tmp/pomo_pid"
STATE_FILE="/tmp/pomo_state"
POMODORO_DURATION=1500  # 25 minutes
BREAK_DURATION=300      # 5 minutes
COFFEE=$(printf '\xEF\x83\xB4 ') # 
POMODORO=$(printf '\xEE\x80\x82 ') # 
POMODORO_DONE=$(printf '\xEE\x80\x81 ') # 
TASK=$(cat /tmp/tmuxmessage | tail -n 1)

if [ -z "$TASK" ]; then
  tmux display-message -d 5000 " $POMODORO_DONE Timer cannot be started without a task"
  exit 0
fi

update_status() {
    echo -e "$1" > "$STATUS_FILE"
    tmux refresh-client -S
}

run_timer() {
    local duration=$1
    local emoji=$2

    SECONDS_LEFT=$duration
    while [ $SECONDS_LEFT -gt 0 ]; do
        MIN=$((SECONDS_LEFT / 60))
        SEC=$((SECONDS_LEFT % 60))
        update_status "$emoji  $(printf "%02d:%02d" $MIN $SEC)"
        sleep 1
        SECONDS_LEFT=$((SECONDS_LEFT - 1))
    done
}

start_pomodoro() {
    # Check if a Pomodoro is already running
    if [ -f "$STATE_FILE" ]; then
        STATE=$(cat "$STATE_FILE")
        if [ "$STATE" = "running" ]; then
            echo "Pomodoro already running. Use 'cancel' to stop it."
            tmux display-message -d 2000 "Update current task: $TASK"
            timew rc.verbose="" start "$TASK"
            exit 0
        elif [ "$STATE" = "break" ]; then
            cancel_pomodoro
        fi
    fi

    (
        # Start a new pomodoro
        timew rc.verbose="" stop
        timew rc.verbose="" start "$TASK"
        tmux display-message "Start tracking task: $TASK"
        echo "running" > "$STATE_FILE"
        run_timer $POMODORO_DURATION $POMODORO

        # End the pomodoro...
        timew rc.verbose="" stop
        update_status "$COFFEE "

        # ... and send notification
        powershell.exe -Command "[System.Media.SystemSounds]::Hand.Play()"
        tmux display-popup -w 80% "echo '$COFFEE  Time for a break $COFFEE  \n'; \
          timew summary :day :no-ids :no-annotations"

        # Start a new coffee break
        sleep 3
        echo "break" > "$STATE_FILE"
        run_timer $BREAK_DURATION $COFFEE

        # End the coffee break
        update_status "$POMODORO_DONE \
          $(timew day | grep Tracked | awk '{print $2}' | awk -F: '{print ($1 != "0" ? $1"h" : "") $2"m"}')"
        rm -f "$PID_FILE" "$STATE_FILE"
    ) &
    echo $! > "$PID_FILE"
}

cancel_pomodoro() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            kill -9 "$PID"
        fi
        update_status ""
        timew rc.verbose="" stop
        rm -f "$PID_FILE" "$STATE_FILE" "$STATUS_FILE"
    fi
}

case "$1" in
    cancel) cancel_pomodoro ;;
    *) start_pomodoro ;;
esac
