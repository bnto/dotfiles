#!/usr/bin/env bash

PROJECT=$(tmux display-message -p '#S')

# taskwarrior
CMD="task rc.defaultwidth:0 rc.verbose:nothing ls created- desc project:$PROJECT or project:"
CMD_NEW="task add {q} project:$PROJECT start:now"
CMD_START="task {1} start"
CMD_TOGGLE="task {1} | grep -q active && task {1} stop || task {1} start"
CMD_SHOW_ALL="task rc.defaultwidth:0 rc.verbose:nothing ls created- desc"
CMD_DELETE="task rc.verbose:nothing rc.confirmation=no delete {1}"
CMD_ECHO="task _get {1}.description"
CMD_UNDO="task rc.confirmation=no undo"
CMD_EDIT="tmux new-window 'task edit {1}'"
CMD_EDIT_INLINE="clear; read -p 'Description: ' -e -i \"\$(task _get {1}.description)\" desc; task {1} modify description:\"\$desc\""

# todo.sh
TASKS="TODOTXT_VERBOSE=0 todo.sh -p list +$PROJECT | sort -nr | sed 's/\ +$PROJECT//g'" # list tasks
SORTED="$TASKS | awk '/\*/' && $TASKS | awk '!/\*/' | sort -nr" # sort the tasks

CMD="$SORTED"
CMD_ECHO="$TASKS | grep ^{1} | cut -d' ' -f2- | tr -d '\r'" # echo the task {1}
CMD_NEW="todo.sh add {q} +$PROJECT"
CMD_TOGGLE="$CMD_ECHO | grep '^\*' && { todo.sh replace {1} \"\$(eval $CMD_ECHO | sed 's/\* //') +$PROJECT\"; } || { todo.sh prepend {1} '*'; }"
CMD_START="$CMD_ECHO | grep '^\*' || { todo.sh prepend {1} '*'; }"
CMD_SHOW_ALL="TODOTXT_VERBOSE=0 todo.sh list"
CMD_SHOW_ALL="$CMD"
CMD_DELETE="todo.sh -n rm {1}"
CMD_EDIT_INLINE="clear; read -p 'Description: ' -e -i \"\$(eval $CMD_ECHO)\" desc; todo.sh replace {1} \"\$desc +$PROJECT\""
CMD_UNDO=""
CMD_EDIT="$CMD_EDIT_INLINE"
CMD_DONE="todo.sh -a done {1}"

eval $CMD | fzf \
  --ansi \
  --with-nth=2.. \
  --header $'\n\e[40m \uf0aeÂ  '"$PROJECT"$' \e[0m \e[32mctrl-a\e[0m add | \e[36mctrl-e\e[0m edit | \e[31mctrl-x\e[0m delete | \e[33mctrl-u\e[0m undo | \e[35menter\e[0m toggle\n\n' \
  --bind "ctrl-a:execute($CMD_NEW)+change-query()+reload($CMD)" \
  --bind "ctrl-x:execute($CMD_DELETE)+reload($CMD)" \
  --bind "ctrl-e:execute($CMD_EDIT_INLINE)+reload($CMD)" \
  --bind "ctrl-p:execute-silent({ printf '\xEF\x82\xAE  '; $CMD_ECHO | sed 's/^\* //' | perl -pe 's/#(?=[A-Z])/##/g'; } > /tmp/tmuxmessage ; $CMD_START ; tmux refresh-client -S)+reload($CMD)+accept" \
  --bind "ctrl-y:execute-silent($CMD_ECHO | xclip -selection clipboard)+reload($CMD)+accept" \
  --bind "ctrl-u:execute($CMD_UNDO)+reload($CMD)" \
  --bind "ctrl-i:execute($CMD_EDIT)+accept" \
  --bind "ctrl-r:reload($CMD)" \
  --bind "ctrl-t:reload($CMD_SHOW_ALL)" \
  --bind "ctrl-d:execute($CMD_DONE)+reload($CMD)" \
  --bind "enter:execute-silent($CMD_TOGGLE)+reload($CMD)"
