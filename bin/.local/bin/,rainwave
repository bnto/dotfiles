#!/usr/bin/env bash

# Update tmux status with the currently played music on rainwave
# info is outputted into the TMUXMUSIC file

RAINWAVE_DEAMON=false
for arg in "$@"; do
  case $arg in
    --deamon) # If --deamon is passed, keep script in the background
      RAINWAVE_DEAMON=true
      shift
      ;;
  esac
done

# Display song info and album art
if [ "$RAINWAVE_DEAMON" = false ]; then
  SONG=$(echo $'\e[47m\e[30m '"$(cat /tmp/tmuxmusic)"$' \e[0m')
  if [ -z "$TMUX" ]; then
    wezterm.exe imgcat /tmp/tmuxmimg
    echo $SONG
  else
      chafa -s 25x10 -c full --dither diffusion --dither-grain 1 --dither-intensity 10 -p on /tmp/tmuxmimg
      echo -e "\n$SONG\n" | sed -E 's/ - / \n /'
  fi
  exit 0;
fi

TMUXMUSIC=/tmp/tmuxmusic
TMUXMUSICIMG=/tmp/tmuxmimg
DATA=$(curl -s "https://rainwave.cc/api4/info?sid=1")
TIMESTAMP=$(echo $DATA | jq -r '.sched_current.end')
SONG=$(echo $DATA | jq -r '.all_stations_info["1"] | [.album, .title] | join (" - ")')

echo -e "\uF001\u00A0 $SONG" > $TMUXMUSIC
curl -s -o $TMUXMUSICIMG "https://rainwave.cc$(echo $DATA | jq '.all_stations_info | .["1"] | .art' | sed 's/"//g')_320.jpg"

while [ "$(date +%s)" -lt "$TIMESTAMP" ]; do
  TIME_LEFT=$(( TIMESTAMP - $(date +%s) ))
  echo -e "\uF001\u00A0 $(( TIME_LEFT / 60 )):$(printf "%02d" $(( TIME_LEFT % 60 ))) $SONG" > $TMUXMUSIC
  sleep 5
done

exec "$0" --deamon &
