#!/usr/bin/env bash

# check if radio is on
mpv=$(ps -ef | grep mpv | grep -v grep | awk '{print $2}' | xargs)
rainwave=$(ps -ef | grep ,rainwave | grep -v grep | awk '{print $2}' | xargs)
MPVSOCKET=/tmp/mpvsocket
ICON=$(printf '\xEF\x80\xA8\x0A') # 

if [[ -n $mpv ]]; then
  
  if [[ -n $rainwave ]]; then
    ,rainwave # Print song info and cover art
  fi

  while true; do
    volume=$(echo '{ "command": ["get_property", "volume"] }' | nc -UN $MPVSOCKET | jq '.data' | awk '{printf "%.0f\n", $1}')
    echo -ne "\r$(printf "\033[K")$ICON  $volume$(printf "\e[?25l")" # 

    # Some escape codes used here:
    #
    # \033[K Replace entire current line
    # \e[?25l Hide cursor
    # \e[?25h Restore cursor

    trap 'echo -ne "$(printf "\e[?25h")"' EXIT

    read -rsn1 key
    # Read input: q to quit ...
    if [[ $key == "q" ]]; then
      kill $mpv
      if [[ -n $rainwave ]]; then
        kill $rainwave
      fi
      break
    fi

    # ... esc to exit ...
    if [[ $key == $'\e' ]]; then
      exit 0
    fi

    # ... p to pause ...
    if [[ $key == "p" ]]; then
      echo "{ \"command\": [\"cycle\", \"pause\"] }" | nc -UN $MPVSOCKET > /dev/null
    fi

    # ... u or <c-u> for volume up ...
    if [[ $key == "u" || $key == $'\x15' ]]; then
      volume=$(echo '{ "command": ["get_property", "volume"] }' | nc -UN $MPVSOCKET | jq '.data')
      volume_up=$(echo "$volume + 25" | bc)
      echo "{ \"command\": [\"set_property\", \"volume\", $volume_up] }" | nc -UN $MPVSOCKET > /dev/null
    fi

    # ... d or <c-d> for volume down
    if [[ $key == "d" || $key == $'\x04' ]]; then
      volume=$(echo '{ "command": ["get_property", "volume"] }' | nc -UN $MPVSOCKET | jq '.data')
      volume_down=$(echo "$volume - 25" | bc)
      echo "{ \"command\": [\"set_property\", \"volume\", $volume_down] }" | nc -UN $MPVSOCKET > /dev/null
    fi
  done
  exit 0
fi

selected=$(fzf --with-nth=1 <<'EOF'
lofi https://youtu.be/jfKfPfyJRdk
vg https://youtu.be/jP9EsyxcdTo
tendo https://youtu.be/mSDmr86MdHw
jazz https://youtu.be/Dx5qFachd3A
coffee https://youtu.be/fEvM-OUbaKs
space https://youtu.be/5-anTj1QrWs
rainwave http://allrelays.rainwave.cc/game.mp3
EOF
)

if [[ -z $selected ]]; then
  exit 0
else

  # Stop any running player
  if [[ -n $mpv ]]; then
    kill $mpv
  fi

  echo $selected

  if [ "${selected%% *}" = "rainwave" ]; then

    if [[ -z $rainwave ]]; then
      echo "Starting deamon..."
      nohup bash ,rainwave --deamon > /dev/null 2>&1 &
    fi

    # Launch rainwave radio
    echo "Now playing..."
    setsid mpv --no-video --volume=100 --input-ipc-server=$MPVSOCKET -v \
      "http://allrelays.rainwave.cc/game.mp3"
  else
    # Launch stream
    echo "Now playing..."
    setsid streamlink $(echo $selected | awk '{print $2}') worst -p mpv -a '
      --no-video --volume=100 --ao=pulse --input-ipc-server='"$MPVSOCKET" -v
  fi
fi

# seemingly defunct streams:
# vg https://youtu.be/re_K5hDjd1M
